{{- include "hlib.deployment" (dict "context" . "override" "multi-depl.deploymentFirst" "values" .Values.deploymentFirst) -}}

{{- define "multi-depl.deploymentFirst" -}}
{{- $env := fromYaml (include "multi-depl.deployment.container.env" .) -}}
metadata:
  labels:
    app.kubernetes.io/name: {{ printf "%s-first" (include "hlib.name" $) | trunc 63 | trimSuffix "-" }}
    app.kubernetes.io/component: producer
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ printf "%s-first" (include "hlib.name" $) | trunc 63 | trimSuffix "-" }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ printf "%s-first" (include "hlib.name" $) | trunc 63 | trimSuffix "-" }}
      annotations:
        checksum/secret: {{ include (print .Template.BasePath "/secret.yaml") $ | sha256sum }}
    spec:
      containers:
      - {{- include "hlib.container" (dict "context" . "env" $env "override" "multi-depl.deploymentFirst.container" "values" .Values.deploymentFirst.container) }}
{{- end -}}

{{- define "multi-depl.deploymentFirst.container" -}}
envFrom:
  - secretRef:
      name: {{ include "hlib.fullname" . }}
{{- end -}}
